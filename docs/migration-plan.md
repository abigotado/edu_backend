# Flyway Migration Plan

## Baseline
- `V1__baseline.sql` already exists to bootstrap Flyway metadata. It will be superseded once the first real migration runs (Flyway will mark the baseline as applied).

## Naming Conventions
- Use **camel case descriptions** with double underscore separator: `V2__create_core_identity_tables.sql`.
- Keep each migration single-responsibility (table creation set, seed data, constraint patch, etc.).
- Include down scripts only if/when we decide to enable `clean` for non-prod; for now we rely on forward-only migrations.

## Target Environments
- **Dev/Test**: use the same migrations. Testcontainers will execute migrations on container startup.
- **Prod**: migrations executed automatically on application boot (ensure backups before structural changes).

## Migration Roadmap
| Version | Scope | Notes |
| --- | --- | --- |
| `V2__create_identity_tables.sql` | Tables: `users`, `profiles`. Add enums via check constraints, unique indexes on `email`. | Insert seed admin/teacher accounts in later migration, not here. |
| `V3__create_catalogue_tables.sql` | Tables: `categories`, `tags`, `course`, `course_tags`, `announcements`. Set FK cascade rules per entity definitions. | Ensure `(teacher_id, slug)` unique constraint. |
| `V4__create_learning_structure.sql` | Tables: `modules`, `lessons`, `lesson_resources`, `assignments`, `assignment_settings` columns (embedded), `submission` (with audit columns). | Add necessary defaults (`order_index`, `allow_late_submission=false`). |
| `V5__create_enrollment_tables.sql` | Tables: `enrollments`, `course_reviews`. Include unique `(course_id, student_id)` constraints. | Seed sample status reference data if needed. |
| `V6__create_quiz_tables.sql` | Tables: `quizzes`, `quiz_questions`, `answer_options`, `quiz_submissions`, `quiz_submission_answers`. | Watch for large text columns and indexes on FK columns. |
| `V7__supporting_indexes.sql` | Additional indexes not covered inline (e.g. partial indexes for active records, GIN indexes for JSONB). | Can be split further if needed. |
| `V8__seed_core_reference_data.sql` | Seed categories, tags, demo courses for demos/tests. Use idempotent `INSERT ... ON CONFLICT DO NOTHING`. | Wrap seeds in transactions. |
| `V9__seed_demo_users.sql` | Seed sample users (admin/teacher/student) with pre-hashed passwords for QA only. | Protect from running in prod via Flyway callbacks or conditional checks. |
| Future | **Patches**: e.g. add columns (soft delete), adjust constraints, create views/materialized views. | Follow `VX__description.sql` with incremental numbers. |

## Detailed Considerations
- **Audit Columns**: `created_at`/`updated_at` managed by JPA; we must set default values (`NOW()`) in migrations to avoid null inserts pre-auditing.
- **Soft Delete Support**: add `deleted_at` columns where entities extend `SoftDeletableEntity`. We currently have the base class in place; migrations for tables using it must include nullable `deleted_at` column.
- **JSONB Columns**: `profiles.social_links`, `profiles.preferences`, `lesson_resources.metadata`. Ensure appropriate column definitions (`jsonb`) and optional indexes (GIN) if query heavy.
- **Check Constraints for Enums**: PostgreSQL `CHECK` or custom domains to enforce values (e.g., `status` columns). Optionally use `CREATE TYPE` for actual enums.
- **Sequences**: Identity strategy uses PostgreSQL `GENERATED BY DEFAULT AS IDENTITY`. Add explicitly to table definitions.
- **Foreign Keys**: Use `ON DELETE` policies matching cascades in JPA (mostly `ON DELETE CASCADE` where orphan removal true). Document mismatches if required.
- **Timestamps**: use `TIMESTAMP WITH TIME ZONE` to align with `OffsetDateTime`.

## Workflow
1. Create migration scripts sequentially under `src/main/resources/db/migration` following above plan.
2. Run `./gradlew flywayClean flywayMigrate` (dev only) or rely on application startup to validate.
3. Update integration tests: ensure Testcontainers picks up new scripts; provide factories for seed data.
4. Document new migrations in CHANGELOG / README as they are applied.

## Next Steps
- Draft `V2` and `V3` migrations immediately (tables for identity + catalogue).
- Once base tables exist, update tests to rely on actual schema rather than Hibernate auto DDL.
- Coordinate data seeding with QA before writing `V8`/`V9` scripts.
